<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GEO-PROJECT || Converter</title>

    <!-- Meta tags -->
    <meta property="og:image:secure_url" content="https://raw.githubusercontent.com/akulelaki696/bg/refs/heads/main/20250106_010158.jpg"/>
    <meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: dark)"/>
    <meta name="theme-color" content="#f8f9fa" media="(prefers-color-scheme: light)"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Favicon -->
    <link rel="icon" href="https://raw.githubusercontent.com/jaka2m/project/refs/heads/main/social/bot.png">
    
    <!-- External CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

<style>
:root {
    /* Warna Utama */
    --primary: #6a11cb;
    --primary-dark: #4f46e5;
    --primary-light: #a0a0ff;
    --secondary: #2575fc;
    --secondary-dark: #1e40af;
    --accent: #ff6b6b;
    --success-color: #38ef7d;

    /* Mode Gelap & Latar Belakang */
    --dark: #0f0c29;
    --dark-light: #302b63;
    --dark-bg: #0f0c29;
    --dark-bg-gradient-1: #302b63;
    --dark-bg-gradient-2: #24243e;
    --card-bg: rgba(15, 14, 32, 0.9);
    --element-bg: rgba(15, 23, 42, 0.6);
    --element-bg-hover: rgba(15, 23, 42, 0.8);

    /* Teks & Batas */
    --text-primary: #ffffff;
    --text-secondary: #a0a0ff;
    --text-muted: rgba(255, 255, 255, 0.5);
    --gray: #64748b;
    --gray-light: #a0a0ff;
    --gray-dark: #334155;
    --border-color: rgba(106, 17, 203, 0.2);

    /* Ukuran & Transisi */
    --border-radius-sm: 8px;
    --border-radius-md: 12px;
    --border-radius-lg: 16px;
    --border-radius-full: 9999px;
    --transition-normal: all 0.3s ease;
    --transition-slow: all 0.5s ease;

    /* Bayangan & Efek */
    --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
    --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
    --glow-primary: 0 0 10px rgba(106, 17, 203, 0.5), 0 0 20px rgba(106, 17, 203, 0.2);
    --glow-secondary: 0 0 15px rgba(37, 117, 252, 0.5);
    --card-shadow: 0 15px 30px rgba(0, 0, 0, 0.7);
    --shadow-inset-light: inset 2px 2px 5px rgba(0, 0, 0, 0.5);
    --shadow-3d: 5px 5px 10px rgba(0,0,0,0.5), -5px -5px 10px rgba(50, 50, 50, 0.1);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: "Rajdhani", sans-serif;
    line-height: 1.6;
    color: var(--text-primary);
    background: linear-gradient(135deg, var(--dark-bg), var(--dark-bg-gradient-1), var(--dark-bg-gradient-2));
    background-attachment: fixed;
    min-height: 100vh;
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow-x: hidden;
    padding: 1rem 0;
}

body::before {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle at 20% 30%, rgba(106, 17, 203, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 80% 70%, rgba(37, 117, 252, 0.15) 0%, transparent 40%);
    z-index: -1;
}

a {
    text-decoration: none;
    color: inherit;
}

button {
    cursor: pointer;
    border: none;
    outline: none;
    background: none;
}

ul, ol {
    list-style: none;
}

.container {
    width: 100%;
    max-width: 480px;
    padding: 0 0.75rem;
    margin-bottom: 1rem;
}

.card {
    background: var(--card-bg);
    border-radius: var(--border-radius-md);
    padding: 1.5rem;
    box-shadow: var(--card-shadow);
    position: relative;
    overflow: hidden;
    border: 1px solid rgba(106, 17, 203, 0.1);
    width: 100%;
}

.card::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
}

.card::after {
    content: "";
    position: absolute;
    top: 3px;
    left: 0;
    width: 100%;
    height: 1px;
    background: linear-gradient(90deg, rgba(106, 17, 203, 0.5), rgba(37, 117, 252, 0.5), rgba(255, 107, 107, 0.5));
    filter: blur(1px);
}

.title-container {
    text-align: center;
    margin-bottom: 1.5rem;
    position: relative;
}

.title {
    font-family: "Orbitron", sans-serif;
    font-weight: 700;
    font-size: 1.8rem;
    letter-spacing: 1px;
    margin: 0;
    background: linear-gradient(90deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    position: relative;
    display: inline-block;
}

.title::after {
    content: "Convert";
    position: absolute;
    top: -8px;
    right: -60px;
    font-size: 0.7rem;
    font-weight: 400;
    background: var(--accent);
    color: var(--dark);
    padding: 2px 5px;
    border-radius: 3px;
    -webkit-text-fill-color: var(--dark);
    transform: rotate(15deg);
}

.subtitle {
    font-size: 0.9rem;
    color: var(--gray-light);
    margin-top: 0.3rem;
}

.nav-buttons {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    padding: 15px 0;
}

.nav-button {
    background: var(--element-bg);
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    transition: var(--transition-normal);
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 5px;
    box-shadow: var(--shadow-3d);
}

.nav-button:hover {
    background: var(--element-bg-hover);
    color: var(--text-primary);
    transform: translateY(-2px) scale(1.05);
}

.nav-button.active {
    background: linear-gradient(90deg, #00ff00, #00cc33);
    color: white;
    border: none;
    box-shadow: var(--shadow-inset-light), 0 0 10px rgba(0, 255, 0, 0.5);
    transform: translateY(0);
}

.converter-container {
    margin-top: 1.5rem;
    position: relative;
}

.direction-selector {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.direction-btn {
    background: var(--element-bg);
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    padding: 0.6rem 1rem;
    border-radius: var(--border-radius-sm);
    font-size: 0.9rem;
    transition: var(--transition-normal);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: var(--shadow-3d);
}

.direction-btn:hover {
    background: var(--element-bg-hover);
    color: var(--light);
    transform: translateY(-2px);
}

.direction-btn.active {
    background: linear-gradient(90deg, var(--primary), var(--secondary));
    color: white;
    border: none;
    box-shadow: var(--shadow-inset-light);
    transform: translateY(0);
}

.converter-section {
    display: flex;
    flex-direction: column;
    gap: 1.2rem;
}

.converter-section.hidden {
    display: none;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.form-group label {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--light);
}

.converter-textarea {
    width: 100%;
    min-height: 150px;
    background: var(--element-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-md);
    color: var(--text-primary);
    padding: 0.8rem;
    font-family: "Share Tech Mono", monospace;
    font-size: 0.85rem;
    resize: vertical;
    transition: var(--transition-normal);
    box-shadow: var(--shadow-inset-light);
}

.converter-textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(106, 17, 203, 0.25), var(--shadow-inset-light);
    background: var(--element-bg-hover);
}
.converter-textarea::placeholder {
    color: var(--text-secondary);
    opacity: 0.6;
}

.format-btn {
    background: var(--element-bg);
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    padding: 0.6rem 1rem;
    border-radius: var(--border-radius-sm);
    font-size: 0.9rem;
    transition: var(--transition-normal);
    box-shadow: var(--shadow-3d);
}

.format-btn:hover {
    background: var(--element-bg-hover);
    color: var(--light);
}

.format-btn.active {
    background: linear-gradient(90deg, var(--primary), var(--secondary));
    color: white;
    border: none;
    box-shadow: var(--shadow-inset-light);
}

.option-group {
    margin-top: 0.8rem;
    margin-bottom: 0.8rem;
}

.option-label {
    display: block;
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--gray-light);
}

.option-selector {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.option-btn {
    background: var(--element-bg);
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    padding: 0.4rem 0.8rem;
    border-radius: 6px;
    font-size: 0.8rem;
    transition: var(--transition-normal);
    box-shadow: var(--shadow-3d);
}

.option-btn:hover {
    background: var(--element-bg-hover);
    color: var(--light);
}

.option-btn.active {
    background: linear-gradient(90deg, var(--primary), var(--secondary));
    color: white;
    border: none;
    box-shadow: var(--shadow-inset-light);
}

.convert-btn {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    border: none;
    border-radius: var(--border-radius-sm);
    padding: 0.8rem;
    font-weight: 600;
    font-size: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    transition: var(--transition-normal);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    position: relative;
    overflow: hidden;
}

.convert-btn::before {
    content: "";
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: 0.5s;
}

.convert-btn:hover::before {
    left: 100%;
}

.convert-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
}

.result-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.result-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.copy-btn, .download-btn {
    padding: 0.4rem 0.8rem;
    border-radius: 6px;
    font-size: 0.8rem;
    transition: var(--transition-normal);
    display: flex;
    align-items: center;
    gap: 0.3rem;
    box-shadow: var(--shadow-3d);
}

.copy-btn {
    background: var(--element-bg);
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
}
.copy-btn:hover {
    background: var(--element-bg-hover);
    color: var(--text-primary);
    transform: translateY(-2px);
}

.download-btn {
    background: var(--element-bg);
    border: 1px solid var(--border-color);
    color: var(--secondary);
}
.download-btn:hover {
    background: var(--element-bg-hover);
    color: var(--primary);
    transform: translateY(-2px);
}

.toast-notification {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: rgba(16, 185, 129, 0.9);
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    display: flex;
    align-items: center;
    gap: 10px;
    z-index: 1000;
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.3s ease, transform 0.3s ease;
}

.toast-notification.show {
    opacity: 1;
    transform: translateY(0);
}

.toast-notification i {
    font-size: 1.2rem;
}

.loading-indicator {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(15, 14, 32, 0.9);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    border-radius: 8px;
    z-index: 10;
}

.loading-indicator.hidden {
    display: none;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(106, 17, 203, 0.3);
    border-radius: 50%;
    border-top-color: var(--primary);
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

.error-message {
    background: rgba(239, 68, 68, 0.2);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #f87171;
    padding: 0.8rem;
    border-radius: 8px;
    font-size: 0.9rem;
    text-align: center;
}

.error-message.hidden {
    display: none;
}

.tech-detail {
    display: none;
}

.footer {
    width: 100%;
    max-width: 480px;
    background: var(--card-bg);
    border-radius: var(--border-radius-md);
    padding: 1.2rem;
    position: relative;
    border: 1px solid rgba(106, 17, 203, 0.1);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    overflow: hidden;
    margin: 0 0.75rem;
}

.footer::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
}

.footer::after {
    content: "";
    position: absolute;
    top: 3px;
    left: 0;
    width: 100%;
    height: 1px;
    background: linear-gradient(90deg, rgba(106, 17, 203, 0.5), rgba(37, 117, 252, 0.5), rgba(255, 107, 107, 0.5));
    filter: blur(1px);
}

.footer-logo {
    font-family: "Orbitron", sans-serif;
    font-weight: 700;
    font-size: 1.1rem;
    margin-bottom: 0.4rem;
    background: linear-gradient(90deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    position: relative;
    display: inline-block;
}

.footer-powered {
    font-size: 0.8rem;
    color: var(--gray-light);
    margin-bottom: 0.6rem;
    font-family: "Share Tech Mono", monospace;
}

.footer-social {
    display: flex;
    justify-content: center;
    gap: 0.8rem;
    margin-bottom: 0.6rem;
    flex-wrap: wrap;
}

.social-link {
    color: var(--primary);
    text-decoration: none;
    font-family: "Share Tech Mono", monospace;
    font-size: 0.8rem;
    padding: 0.25rem 0.6rem;
    border-radius: 4px;
    background: rgba(106, 17, 203, 0.05);
    border: 1px solid rgba(106, 17, 203, 0.1);
    transition: var(--transition-normal);
    display: flex;
    align-items: center;
    gap: 0.3rem;
}

.social-link:hover {
    background: rgba(106, 17, 203, 0.1);
    box-shadow: var(--glow-primary);
    transform: translateY(-2px);
}

.social-icon {
    width: 14px;
    height: 14px;
}

.footer-year {
    font-family: "Orbitron", sans-serif;
    font-weight: 600;
    font-size: 0.8rem;
    color: var(--accent);
    margin-top: 0.4rem;
    letter-spacing: 1px;
}

#mode-toggle {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--element-bg);
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-3d);
    color: var(--text-primary);
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 20;
    transition: var(--transition-normal);
}

#mode-toggle:hover {
    transform: translateY(-2px);
    box-shadow: 0 0 10px var(--primary);
}

#mode-toggle.active {
    box-shadow: var(--shadow-inset-light);
    transform: translateY(0);
}

@media (max-width: 480px) {
    .title {
        font-size: 1.5rem;
    }
    .subtitle {
        font-size: 0.8rem;
    }
    .direction-selector {
        flex-direction: column;
        gap: 0.5rem;
    }
    .direction-btn {
        width: 100%;
        justify-content: center;
    }
    .converter-textarea {
        min-height: 120px;
    }
    .option-selector {
        flex-direction: row;
        flex-wrap: wrap;
    }
    .option-btn {
        font-size: 0.7rem;
        padding: 0.3rem 0.6rem;
    }
}
</style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="tech-detail tech-detail-1"></div>
            <div class="tech-detail tech-detail-2"></div>
            <div class="tech-detail tech-detail-3"></div>
            <div class="title-container">
                <h1 class="title">GEO - PROJECT</h1>
                <p class="subtitle">Converter</p>
            </div>
            <div class="nav-buttons">
                <a href="https://gamang.gpj2.dpdns.org/sub" class="nav-button">
                    <i class="fas fa-home"></i> Home
                </a>
                <a href="https://gamang.gpj2.dpdns.org/kuota" class="nav-button">
                    <i class="fas fa-link"></i> Cek Kuota
                </a>
                <a href="https://gamang.gpj2.dpdns.org/convert" class="nav-button active">
                    <i class="fas fa-exchange-alt"></i> Converter
                </a>
                <a href="https://gamang.gpj2.dpdns.org/checker" class="nav-button">
                    <i class="fas fa-cloud"></i> IP Checker
                </a>
            </div>
            <div class="converter-container">
                <div class="direction-selector">
                    <button id="v2ray-to-config" class="direction-btn active">
                        <i class="fas fa-arrow-right"></i> V2Ray to Config
                    </button>
                    <button id="config-to-v2ray" class="direction-btn">
                        <i class="fas fa-arrow-left"></i> Config to V2Ray
                    </button>
                </div>
                <div id="v2ray-to-config-section" class="converter-section">
                    <div class="form-group">
                        <label for="v2ray-input"></label>
                        <textarea id="v2ray-input" class="converter-textarea" placeholder="Paste your V2Ray links here, one per line..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Output Format</label>
                        <div class="format-selector">
                            <button id="clash-format" class="format-btn active">Clash</button>
                            <button id="nekobox-format" class="format-btn">Nekobox</button>
                        </div>
                    </div>
                    <div class="form-group" id="clash-options" style="margin-top: 1rem;">
                        <label>Clash Configuration Options</label>
                        <div class="option-group">
                            <label class="option-label">DNS Mode:</label>
                            <div class="option-selector">
                                <button id="fake-ip" class="option-btn active">Fake IP</button>
                                <button id="redir-host" class="option-btn">Redir Host</button>
                            </div>
                        </div>
                        <div class="option-group">
                            <label class="option-label">Proxy Groups:</label>
                            <div class="option-selector">
                                <button id="best-ping" class="option-btn active">Best Ping</button>
                                <button id="load-balance" class="option-btn">Load Balance</button>
                                <button id="fallback" class="option-btn">Fallback</button>
                                <button id="all-groups" class="option-btn">All Groups</button>
                            </div>
                        </div>
                        <div class="option-group">
                            <label class="option-label">Rule Sets:</label>
                            <div class="option-selector">
                                <button id="ads-block" class="option-btn active">Ads Block</button>
                                <button id="porn-block" class="option-btn active">Porn Block</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Configuration Type</label>
                        <div class="config-type-selector">
                            <button id="minimal-config" class="format-btn active">Minimal (Proxies Only)</button>
                            <button id="full-config" class="format-btn">Full Configuration</button>
                        </div>
                    </div>
                    <button id="convert-v2ray" class="convert-btn">
                        <i class="fas fa-sync-alt"></i> Convert
                    </button>
                    <div class="form-group">
                        <div class="result-header">
                            <label for="config-output">Result</label>
                            <div class="result-actions">
                                <button id="copy-config" class="copy-btn">
                                    <i class="far fa-copy"></i> Copy
                                </button>
                                <button id="save-proxy-provider" class="download-btn">
                                    <i class="fas fa-download"></i> Save Proxy
                                </button>
                                <button id="save-full-config" class="download-btn">
                                    <i class="fas fa-file-download"></i> Save Full
                                </button>
                            </div>
                        </div>
                        <textarea id="config-output" class="converter-textarea result-textarea" readonly placeholder="Converted configuration will appear here..."></textarea>
                    </div>
                </div>
                <div id="config-to-v2ray-section" class="converter-section hidden">
                    <div class="form-group">
                        <label for="config-type">Config Type</label>
                        <div class="format-selector">
                            <button id="clash-type" class="format-btn active">Clash</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Configuration Type</label>
                        <div class="config-type-selector">
                            <button id="minimal-config-reverse" class="format-btn active">Minimal (Proxies Only)</button>
                            <button id="full-config-reverse" class="format-btn">Full Configuration</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="config-input">Configuration</label>
                        <textarea id="config-input" class="converter-textarea" placeholder="Paste your Clash or Nekobox configuration here..."></textarea>
                    </div>
                    <button id="convert-config" class="convert-btn">
                        <i class="fas fa-sync-alt"></i> Convert
                    </button>
                    <div class="form-group">
                        <div class="result-header">
                            <label for="v2ray-output">Result</label>
                            <div class="result-actions">
                                <button id="copy-v2ray" class="copy-btn">
                                    <i class="far fa-copy"></i> Copy
                                </button>
                                <button id="save-v2ray-links" class="download-btn">
                                    <i class="fas fa-download"></i> Save Links
                                </button>
                            </div>
                        </div>
                        <textarea id="v2ray-output" class="converter-textarea result-textarea" readonly placeholder="Converted V2Ray links will appear here..."></textarea>
                    </div>
                </div>
                <div id="loading-indicator" class="loading-indicator hidden">
                    <div class="spinner"></div>
                    <p>Converting...</p>
                </div>
                <div id="error-message" class="error-message hidden"></div>
            </div>
        </div>
    </div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- UTILITY FUNCTIONS ---

    // Generates a v4 UUID.
    function generateUUIDv4() {
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, c => {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    // Safely copies text to the clipboard, handling potential errors.
    async function copyToClipboard(text) {
        try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(text);
                return true;
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                const success = document.execCommand('copy');
                document.body.removeChild(textArea);
                return success;
            }
        } catch (error) {
            console.error("Failed to copy text: ", error);
            return false;
        }
    }

    // Displays a toast notification.
    function showToast(message, type = 'info', duration = 3000) {
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            Object.assign(toastContainer.style, {
                position: 'fixed',
                bottom: '20px',
                right: '20px',
                zIndex: '9999'
            });
            document.body.appendChild(toastContainer);
        }

        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        Object.assign(toast.style, {
            minWidth: '250px',
            margin: '10px 0',
            padding: '15px',
            borderRadius: '8px',
            boxShadow: '0 4px 12px rgba(0, 0, 0, 0.15)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'space-between',
            animation: `fadeIn 0.3s, fadeOut 0.3s ${duration / 1000 - 0.3}s forwards`
        });

        const colors = {
            success: 'rgba(16, 185, 129, 0.9)',
            error: 'rgba(239, 68, 68, 0.9)',
            info: 'rgba(99, 102, 241, 0.9)'
        };
        toast.style.backgroundColor = colors[type] || colors.info;

        const icons = {
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            info: 'fa-info-circle'
        };
        const iconClass = icons[type] || icons.info;

        toast.innerHTML = `
            <div style="display: flex; align-items: center;">
                <span style="margin-right: 10px; font-size: 18px;"><i class="fas ${iconClass}"></i></span>
                <span style="color: white;">${message}</span>
            </div>
            <button style="background: none; border: none; color: white; cursor: pointer; font-size: 16px;">
                <i class="fas fa-times"></i>
            </button>
        `;

        toast.querySelector('button').addEventListener('click', () => {
            toastContainer.removeChild(toast);
        });

        toastContainer.appendChild(toast);

        if (!document.getElementById('toast-styles')) {
            const styleSheet = document.createElement('style');
            styleSheet.id = 'toast-styles';
            styleSheet.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; transform: translateY(20px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                @keyframes fadeOut {
                    from { opacity: 1; transform: translateY(0); }
                    to { opacity: 0; transform: translateY(-20px); }
                }
            `;
            document.head.appendChild(styleSheet);
        }

        setTimeout(() => {
            if (toastContainer.contains(toast)) {
                toastContainer.removeChild(toast);
            }
        }, duration);
    }

    // --- DOM ELEMENT SELECTORS ---
    const v2rayToConfigBtn = document.getElementById('v2ray-to-config');
    const configToV2rayBtn = document.getElementById('config-to-v2ray');
    const v2rayToConfigSection = document.getElementById('v2ray-to-config-section');
    const configToV2raySection = document.getElementById('config-to-v2ray-section');

    const v2rayInput = document.getElementById('v2ray-input');
    const configInput = document.getElementById('config-input');
    const configOutput = document.getElementById('config-output');
    const v2rayOutput = document.getElementById('v2ray-output');

    const convertToConfigBtn = document.getElementById('convert-v2ray');
    const convertToV2rayBtn = document.getElementById('convert-config');
    const copyConfigBtn = document.getElementById('copy-config');
    const copyV2rayBtn = document.getElementById('copy-v2ray');

    const loadingIndicator = document.getElementById('loading-indicator');
    const errorMessage = document.getElementById('error-message');

    // Format buttons
    const clashFormatBtn = document.getElementById('clash-format');
    const nekoboxFormatBtn = document.getElementById('nekobox-format');
    const clashTypeBtn = document.getElementById('clash-type'); // For reverse conversion

    // Config type buttons
    const minimalConfigBtn = document.getElementById('minimal-config');
    const fullConfigBtn = document.getElementById('full-config');
    const minimalConfigReverseBtn = document.getElementById('minimal-config-reverse');
    const fullConfigReverseBtn = document.getElementById('full-config-reverse');

    // Clash options
    const clashOptionsContainer = document.getElementById('clash-options');
    const fakeIpBtn = document.getElementById('fake-ip');
    const redirHostBtn = document.getElementById('redir-host');
    const bestPingBtn = document.getElementById('best-ping');
    const loadBalanceBtn = document.getElementById('load-balance');
    const fallbackBtn = document.getElementById('fallback');
    const allGroupsBtn = document.getElementById('all-groups');
    const adsBlockBtn = document.getElementById('ads-block');
    const pornBlockBtn = document.getElementById('porn-block');

    // Save buttons
    const saveProxyProviderBtn = document.getElementById('save-proxy-provider');
    const saveFullConfigBtn = document.getElementById('save-full-config');
    const saveV2rayLinksBtn = document.getElementById('save-v2ray-links');


    // --- UI LOGIC ---

    // Hides the error message.
    function clearError() {
        errorMessage.classList.add('hidden');
    }

    // Shows an error message.
    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.remove('hidden');
    }

    // Toggles visibility of Clash-specific options.
    function toggleClashOptions() {
        const selectedFormat = document.querySelector('.format-btn.active').id;
        clashOptionsContainer.style.display = selectedFormat === 'clash-format' ? 'block' : 'none';
    }

    // Updates button visibility based on config type.
    function updateSaveButtons() {
        if (minimalConfigBtn.classList.contains('active')) {
            saveProxyProviderBtn.style.display = 'flex';
            saveFullConfigBtn.style.display = 'none';
        } else {
            saveProxyProviderBtn.style.display = 'none';
            saveFullConfigBtn.style.display = 'flex';
        }
    }

    // --- EVENT LISTENERS ---

    v2rayToConfigBtn.addEventListener('click', () => {
        v2rayToConfigBtn.classList.add('active');
        configToV2rayBtn.classList.remove('active');
        v2rayToConfigSection.classList.remove('hidden');
        configToV2raySection.classList.add('hidden');
        clearError();
    });

    configToV2rayBtn.addEventListener('click', () => {
        configToV2rayBtn.classList.add('active');
        v2rayToConfigBtn.classList.remove('active');
        configToV2raySection.classList.remove('hidden');
        v2rayToConfigSection.classList.add('hidden');
        clearError();
    });

    [clashFormatBtn, nekoboxFormatBtn].forEach(btn => {
        btn.addEventListener('click', () => {
            clashFormatBtn.classList.toggle('active', btn === clashFormatBtn);
            nekoboxFormatBtn.classList.toggle('active', btn === nekoboxFormatBtn);
            toggleClashOptions();
            clearError();
        });
    });

    [minimalConfigBtn, fullConfigBtn].forEach(btn => {
        btn.addEventListener('click', () => {
            minimalConfigBtn.classList.toggle('active', btn === minimalConfigBtn);
            fullConfigBtn.classList.toggle('active', btn === fullConfigBtn);
            updateSaveButtons();
            clearError();
        });
    });

    [minimalConfigReverseBtn, fullConfigReverseBtn].forEach(btn => {
        btn.addEventListener('click', () => {
            minimalConfigReverseBtn.classList.toggle('active', btn === minimalConfigReverseBtn);
            fullConfigReverseBtn.classList.toggle('active', btn === fullConfigReverseBtn);
            clearError();
        });
    });


    [fakeIpBtn, redirHostBtn].forEach(btn => {
        btn.addEventListener('click', () => {
            fakeIpBtn.classList.toggle('active', btn === fakeIpBtn);
            redirHostBtn.classList.toggle('active', btn === redirHostBtn);
            clearError();
        });
    });

    [bestPingBtn, loadBalanceBtn, fallbackBtn, adsBlockBtn, pornBlockBtn].forEach(btn => {
        btn.addEventListener('click', () => {
            btn.classList.toggle('active');
            clearError();
        });
    });

    allGroupsBtn.addEventListener('click', () => {
        const isActivating = !allGroupsBtn.classList.contains('active');
        allGroupsBtn.classList.toggle('active', isActivating);
        bestPingBtn.classList.toggle('active', isActivating);
        loadBalanceBtn.classList.toggle('active', isActivating);
        fallbackBtn.classList.toggle('active', isActivating);
        clearError();
    });

    convertToConfigBtn.addEventListener('click', () => {
        const links = v2rayInput.value.trim();
        if (!links) {
            showError("Please enter V2Ray links to convert.");
            return;
        }
        loadingIndicator.classList.remove('hidden');
        setTimeout(() => {
            try {
                const result = convertV2RayToConfig(links);
                configOutput.value = result;
            } catch (error) {
                showError(error.message || "Failed to convert. Check input.");
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }, 200);
    });

    convertToV2rayBtn.addEventListener('click', () => {
        const config = configInput.value.trim();
        if (!config) {
            showError("Please enter a configuration to convert.");
            return;
        }
        loadingIndicator.classList.remove('hidden');
        setTimeout(() => {
            try {
                const result = convertConfigToV2Ray(config);
                v2rayOutput.value = result;
            } catch (error) {
                showError(error.message || "Failed to convert. Check input.");
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }, 200);
    });

    copyConfigBtn.addEventListener('click', () => {
        copyToClipboard(configOutput.value);
        copyConfigBtn.innerHTML = `<i class="fas fa-check"></i> Copied!`;
        setTimeout(() => {
            copyConfigBtn.innerHTML = `<i class="far fa-copy"></i> Copy`;
        }, 1500);
    });

    copyV2rayBtn.addEventListener('click', () => {
        copyToClipboard(v2rayOutput.value);
        copyV2rayBtn.innerHTML = `<i class="fas fa-check"></i> Copied!`;
        setTimeout(() => {
            copyV2rayBtn.innerHTML = `<i class="far fa-copy"></i> Copy`;
        }, 1500);
    });

    function downloadFile(content, filename, type = 'text/yaml') {
        const blob = new Blob([content], {
            type
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast(`File "${filename}" downloaded successfully!`, 'success');
    }


    saveProxyProviderBtn.addEventListener('click', () => {
        const content = configOutput.value;
        if (!content) {
            showError("No content to save. Please convert first.");
            return;
        }
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
        downloadFile(content, `proxy_provider_${timestamp}.yaml`);
    });

    saveFullConfigBtn.addEventListener('click', () => {
        const content = configOutput.value;
        if (!content) {
            showError("No content to save. Please convert first.");
            return;
        }
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
        downloadFile(content, `Geo-Project_${timestamp}.yaml`);
    });

    saveV2rayLinksBtn.addEventListener('click', () => {
        const content = v2rayOutput.value;
        if (!content) {
            showError("No content to save. Please convert first.");
            return;
        }
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
        downloadFile(content, `v2ray_links_${timestamp}.txt`, 'text/plain');
    });

    // --- CORE CONVERSION LOGIC ---

    function convertV2RayToConfig(links) {
        const linkArray = links.split(/\r?\n/).filter(link => link.trim() !== '');
        if (linkArray.length === 0) {
            throw new Error("No valid V2Ray links found.");
        }

        const proxies = linkArray.map(parseV2RayLink);
        const isFullConfig = fullConfigBtn.classList.contains('active');
        const useClashFormat = clashFormatBtn.classList.contains('active');

        if (useClashFormat) {
            const clashOptions = {
                useFakeIp: fakeIpBtn.classList.contains('active'),
                useBestPing: bestPingBtn.classList.contains('active'),
                useLoadBalance: loadBalanceBtn.classList.contains('active'),
                useFallback: fallbackBtn.classList.contains('active'),
                useAllGroups: allGroupsBtn.classList.contains('active'),
                useAdsBlock: adsBlockBtn.classList.contains('active'),
                usePornBlock: pornBlockBtn.classList.contains('active'),
            };
            return generateClashConfig(proxies, isFullConfig, clashOptions);
        } else {
            return generateNekoboxConfig(proxies, isFullConfig);
        }
    }


    function convertConfigToV2Ray(configData) {
        try {
            const lines = configData.split('\n');
            const proxies = [];
            let inProxiesSection = false;
            let currentProxy = {};
            let indentLevel = 0;

            for (const line of lines) {
                const trimmedLine = line.trim();
                if (trimmedLine === '' || trimmedLine.startsWith('#')) continue;

                if (trimmedLine === 'proxies:') {
                    inProxiesSection = true;
                    continue;
                }
                if (!inProxiesSection) continue;

                const currentIndent = line.search(/\S/);

                if (trimmedLine.startsWith("- name:")) {
                    if (Object.keys(currentProxy).length > 0) {
                        proxies.push(currentProxy);
                    }
                    currentProxy = {
                        name: line.match(/- name: "(.+)"/)?.[1] || ''
                    };
                    indentLevel = currentIndent;
                } else if (currentIndent <= indentLevel && (trimmedLine.includes(":") && !trimmedLine.startsWith('- '))) {
                    // Exiting proxies section
                    if (trimmedLine === "proxy-groups:" || trimmedLine === "rules:") {
                        inProxiesSection = false;
                        if (Object.keys(currentProxy).length > 0) {
                            proxies.push(currentProxy);
                            currentProxy = {};
                        }
                        continue;
                    }
                }


                if (Object.keys(currentProxy).length > 0) {
                    const match = (key) => line.match(new RegExp(`${key}:\\s*(.+)`));
                    const value = (key) => match(key)?.[1].trim();

                    if (line.includes("type:")) currentProxy.type = value('type');
                    else if (line.includes("server:")) currentProxy.server = value('server');
                    else if (line.includes("port:")) currentProxy.port = parseInt(value('port'), 10);
                    else if (line.includes("uuid:")) currentProxy.uuid = value('uuid');
                    else if (line.includes("password:")) currentProxy.password = value('password');
                    else if (line.includes("cipher:")) currentProxy.cipher = value('cipher');
                    else if (line.includes("tls:")) currentProxy.tls = value('tls') === 'true';
                    else if (line.includes("network:")) currentProxy.network = value('network');
                    else if (line.includes("servername:") || line.includes("sni:")) currentProxy.sni = value('servername') || value('sni');
                    else if (line.includes('path:') && !line.includes("ws-opts:")) currentProxy.path = value('path');
                    else if (line.includes('ws-opts:')) currentProxy.wsOpts = {};
                    else if (currentProxy.wsOpts && line.includes("path:")) currentProxy.path = value('path');
                    else if (currentProxy.wsOpts && line.includes("headers:")) currentProxy.wsOpts.headers = {};
                    else if (currentProxy.wsOpts?.headers && line.includes("Host:")) currentProxy.host = value('Host');
                }
            }

            if (Object.keys(currentProxy).length > 0) {
                proxies.push(currentProxy);
            }

            return proxies.map(proxy => {
                let link = '';
                if (proxy.type === 'vmess') {
                    const vmessData = {
                        v: '2',
                        ps: proxy.name,
                        add: proxy.server,
                        port: proxy.port,
                        id: proxy.uuid,
                        aid: '0',
                        net: proxy.network || 'tcp',
                        type: 'none',
                        host: proxy.host || proxy.server,
                        path: proxy.path || '',
                        tls: proxy.tls ? 'tls' : '',
                        sni: proxy.sni || proxy.server,
                        scy: proxy.cipher || 'auto',
                    };
                    link = 'vmess://' + btoa(JSON.stringify(vmessData));
                } else if (proxy.type === 'vless') {
                    const params = new URLSearchParams({
                        encryption: 'none',
                        security: proxy.tls ? 'tls' : 'none',
                        type: proxy.network || 'tcp',
                        host: proxy.host || proxy.server,
                        path: proxy.path || '',
                        sni: proxy.sni || proxy.server,
                    });
                    link = `vless://${proxy.uuid}@${proxy.server}:${proxy.port}?${params.toString()}#${encodeURIComponent(proxy.name)}`;
                } else if (proxy.type === 'trojan') {
                    const params = new URLSearchParams({
                        security: proxy.tls ? 'tls' : 'none',
                        type: proxy.network || 'tcp',
                        host: proxy.host || proxy.server,
                        path: proxy.path || '',
                        sni: proxy.sni || proxy.server,
                    });
                    link = `trojan://${proxy.password || proxy.uuid}@${proxy.server}:${proxy.port}?${params.toString()}#${encodeURIComponent(proxy.name)}`;
                } else if (proxy.type === 'ss') {
                    const base = btoa(`${proxy.cipher || 'none'}:${proxy.password}`);
                    link = `ss://${base}@${proxy.server}:${proxy.port}#${encodeURIComponent(proxy.name)}`;
                    if (proxy.network === 'ws' || proxy.path) {
                        const pluginParams = `plugin=v2ray-plugin;path=${proxy.path || ''};host=${proxy.host || proxy.server};tls=${proxy.tls ? '1' : '0'}`;
                        link = `ss://${base}@${proxy.server}:${proxy.port}/?${encodeURIComponent(pluginParams)}#${encodeURIComponent(proxy.name)}`;
                    }
                }
                return link;
            }).filter(Boolean).join('\n');

        } catch (error) {
            console.error("Error parsing Clash config:", error);
            throw new Error("Failed to parse Clash configuration. Please check the format.");
        }
    }


    function parseV2RayLink(link) {
        try {
            if (link.startsWith("vmess://")) return parseVmessLink(link);
            if (link.startsWith("vless://")) return parseVlessLink(link);
            if (link.startsWith("trojan://")) return parseTrojanLink(link);
            if (link.startsWith("ss://")) return parseShadowsocksLink(link);
            throw new Error(`Unsupported protocol in link: ${link.substring(0, 20)}...`);
        } catch (error) {
            console.error("Error parsing link:", error);
            throw new Error(`Failed to parse link: ${link.substring(0, 30)}...`);
        }
    }

    function parseVmessLink(link) {
        const data = JSON.parse(atob(link.replace("vmess://", "")));
        return {
            type: "vmess",
            name: data.ps || "VMess Server",
            server: data.add,
            port: parseInt(data.port, 10),
            uuid: data.id,
            alterId: parseInt(data.aid || '0', 10),
            cipher: data.scy || "auto",
            tls: data.tls === 'tls',
            network: data.net || "tcp",
            wsPath: data.path || '',
            wsHost: data.host || '',
            sni: data.sni || data.add,
            skipCertVerify: true,
        };
    }

    function parseVlessLink(link) {
        const url = new URL(link);
        return {
            type: "vless",
            name: url.hash ? decodeURIComponent(url.hash.substring(1)) : "VLESS Server",
            server: url.hostname,
            port: parseInt(url.port, 10),
            uuid: url.username,
            tls: url.searchParams.get('security') === "tls",
            network: url.searchParams.get('type') || "tcp",
            wsPath: url.searchParams.get('path') || '',
            wsHost: url.searchParams.get('host') || '',
            sni: url.searchParams.get('sni') || url.hostname,
            skipCertVerify: true,
        };
    }

    function parseTrojanLink(link) {
        const url = new URL(link);
        return {
            type: "trojan",
            name: url.hash ? decodeURIComponent(url.hash.substring(1)) : "Trojan Server",
            server: url.hostname,
            port: parseInt(url.port, 10),
            password: url.username,
            tls: url.searchParams.get('security') === "tls" || true, // Default to true for Trojan
            network: url.searchParams.get('type') || "tcp",
            wsPath: url.searchParams.get('path') || '',
            wsHost: url.searchParams.get('host') || '',
            sni: url.searchParams.get('sni') || url.hostname,
            skipCertVerify: true,
        };
    }

    function parseShadowsocksLink(link) {
        const url = new URL(link);
        const [cipher, password] = atob(url.username).split(':');
        let pluginOpts = {};
        if (url.search) {
             const pluginStr = decodeURIComponent(url.search.slice(1));
             pluginStr.split(';').forEach(part => {
                 const [key, value] = part.split('=');
                 if(key === 'plugin' && value === 'v2ray-plugin') {
                    // this is expected
                 } else {
                    pluginOpts[key] = value;
                 }
             });
        }

        return {
            type: 'ss',
            name: url.hash ? decodeURIComponent(url.hash.substring(1)) : "SS Server",
            server: url.hostname,
            port: parseInt(url.port, 10),
            cipher: cipher,
            password: password,
            udp: false,
            tls: pluginOpts.tls === '1',
            wsPath: pluginOpts.path || '',
            wsHost: pluginOpts.host || url.hostname,
            sni: pluginOpts.sni || url.hostname,
            skipCertVerify: true,
        };
    }

    function generateClashConfig(proxies, isFullConfig, options) {
        let config = `# Clash Configuration\n# Generated by Geo-Project Converter\n# Date: ${new Date().toISOString()}\n\n`;

        if (isFullConfig) {
            config += `port: 7890
socks-port: 7891
allow-lan: true
mode: rule
log-level: info
external-controller: 127.0.0.1:9090
dns:
  enable: true
  listen: 0.0.0.0:53
  enhanced-mode: ${options.useFakeIp ? "fake-ip" : "redir-host"}
  nameserver:
    - 8.8.8.8
    - 1.1.1.1
    - https://dns.cloudflare.com/dns-query
  fallback:
    - 1.0.0.1
    - 8.8.4.4
    - https://dns.google/dns-query

`;
            if (options.useAdsBlock || options.usePornBlock) {
                config += "rule-providers:\n";
                if (options.useAdsBlock) {
                    config += `
  🚫 ADS:
    type: http
    behavior: domain
    url: "https://raw.githubusercontent.com/malikshi/open_clash/refs/heads/main/rule_provider/rule_basicads.yaml"
    path: "./rule_provider/rule_basicads.yaml"
    interval: 86400
`;
                }
                if (options.usePornBlock) {
                    config += `
  🔞 Porn:
    type: http
    behavior: domain
    url: "https://raw.githubusercontent.com/malikshi/open_clash/refs/heads/main/rule_provider/rule_porn.yaml"
    path: "./rule_provider/rule_porn.yaml"
    interval: 86400
`;
                }
            }
        }

        config += "\nproxies:\n";
        proxies.forEach((p, i) => {
            config += `\n  - name: "[${i + 1}]-${p.name}"\n`;
            config += `    type: ${p.type}\n`;
            config += `    server: ${p.server}\n`;
            config += `    port: ${p.port}\n`;
            if (p.uuid) config += `    uuid: ${p.uuid}\n`;
            if (p.password) config += `    password: ${p.password}\n`;
            if (p.type === 'vmess') {
                config += `    alterId: ${p.alterId || 0}\n`;
                config += `    cipher: ${p.cipher || 'auto'}\n`;
            }
             if (p.type === 'ss') {
                config += `    cipher: ${p.cipher || 'none'}\n`;
            }
            config += `    udp: true\n`;
            if (p.type !== 'ss') {
                config += `    tls: ${p.tls}\n`;
                config += `    skip-cert-verify: ${p.skipCertVerify || true}\n`;
            }

            if (p.network === 'ws') {
                config += `    network: ws\n`;
                config += `    ws-opts:\n`;
                config += `      path: "${p.wsPath || '/'}"\n`;
                if (p.wsHost) {
                    config += `      headers:\n        Host: ${p.wsHost}\n`;
                }
            }
            
            if (p.type === 'ss' && p.network === 'ws') {
                 config += `    plugin: v2ray-plugin\n`;
                 config += `    client-fingerprint: chrome\n`;
                 config += `    plugin-opts:\n`;
                 config += `      mode: websocket\n`;
                 config += `      host: ${p.wsHost || p.server}\n`;
                 config += `      path: "${p.wsPath || '/'}"\n`;
                 config += `      tls: ${p.tls}\n`;
                 config += `      skip-cert-verify: true\n`;
            }


            if (p.tls && p.sni) {
                const sniKey = p.type === 'trojan' ? 'sni' : 'servername';
                config += `    ${sniKey}: ${p.sni}\n`;
            }
        });

        if (isFullConfig) {
            const proxyNames = proxies.map((p, i) => `"[${i + 1}]-${p.name}"`).join('\n      - ');
            config += "\nproxy-groups:\n  - name: \"GEO-PROJECT\"\n    type: select\n    proxies:\n      - SELECTOR\n";
            if (options.useBestPing) config += "      - BEST-PING\n";
            if (options.useLoadBalance) config += "      - LOAD-BALANCE\n";
            if (options.useFallback) config += "      - FALLBACK\n";
            config += "      - DIRECT\n      - REJECT\n";

            config += `  - name: "SELECTOR"\n    type: select\n    proxies:\n      - DIRECT\n      - REJECT\n      - ${proxyNames}\n`;

            if (options.useBestPing) {
                config += `\n  - name: "BEST-PING"\n    type: url-test\n    url: http://www.gstatic.com/generate_204\n    interval: 300\n    tolerance: 50\n    proxies:\n      - ${proxyNames}\n`;
            }
            if (options.useLoadBalance) {
                config += `\n  - name: "LOAD-BALANCE"\n    type: load-balance\n    url: http://www.gstatic.com/generate_204\n    interval: 300\n    strategy: round-robin\n    proxies:\n      - ${proxyNames}\n`;
            }
            if (options.useFallback) {
                config += `\n  - name: "FALLBACK"\n    type: fallback\n    url: http://www.gstatic.com/generate_204\n    interval: 300\n    proxies:\n      - ${proxyNames}\n`;
            }

            if (options.useAdsBlock) {
                config += "\n  - name: \"ADS\"\n    type: select\n    proxies:\n      - REJECT\n      - DIRECT\n";
                if (options.useBestPing) config += "      - BEST-PING\n";
            }
            if (options.usePornBlock) {
                config += "\n  - name: \"PORN\"\n    type: select\n    proxies:\n      - REJECT\n      - DIRECT\n";
                if (options.useBestPing) config += "      - BEST-PING\n";
            }

            config += "\nrules:\n";
            if (options.useAdsBlock) config += "  - RULE-SET,🚫 ADS,ADS\n";
            if (options.usePornBlock) config += "  - RULE-SET,🔞 Porn,PORN\n";
            config += `  - IP-CIDR,192.168.0.0/16,DIRECT
  - IP-CIDR,10.0.0.0/8,DIRECT
  - IP-CIDR,172.16.0.0/12,DIRECT
  - IP-CIDR,127.0.0.0/8,DIRECT
  - MATCH,GEO-PROJECT`;
        }

        return config;
    }


    function generateNekoboxConfig(proxies, isFullConfig) {
        const useBestPing = bestPingBtn.classList.contains('active');
        const useLoadBalance = loadBalanceBtn.classList.contains('active');
        const useFallback = fallbackBtn.classList.contains('active');
        const useAllGroups = allGroupsBtn.classList.contains('active');

        let outbounds = [];
        const selectorOutbounds = [];

        if (useBestPing || useAllGroups) selectorOutbounds.push("Best Latency");
        if (useLoadBalance || useAllGroups) selectorOutbounds.push("Load Balance");
        if (useFallback || useAllGroups) selectorOutbounds.push("Fallback");
        if(selectorOutbounds.length === 0) selectorOutbounds.push("Best Latency"); // Default

        const proxyNames = proxies.map(p => p.name);
        selectorOutbounds.push(...proxyNames, "direct");

        outbounds.push({
            outbounds: selectorOutbounds,
            tag: "Internet",
            type: "selector"
        });

        if (useBestPing || useAllGroups) {
            outbounds.push({
                interval: "1m0s",
                outbounds: [...proxyNames, "direct"],
                tag: "Best Latency",
                type: "urltest",
                url: "https://detectportal.firefox.com/success.txt"
            });
        }
        if (useLoadBalance || useAllGroups) {
            outbounds.push({
                interval: "1m0s",
                outbounds: [...proxyNames, "direct"],
                tag: "Load Balance",
                type: "loadbalance",
                strategy: "round-robin"
            });
        }
        if (useFallback || useAllGroups) {
            outbounds.push({
                interval: "1m0s",
                outbounds: [...proxyNames, "direct"],
                tag: "Fallback",
                type: "urltest",
                url: "https://detectportal.firefox.com/success.txt",
                fallback_delay: "300ms"
            });
        }

        proxies.forEach(p => {
            let outbound = {
                tag: p.name,
                type: p.type,
                server: p.server,
                server_port: p.port,
            };

            if (p.type === 'vmess') {
                outbound.uuid = p.uuid;
                outbound.alter_id = p.alterId || 0;
                outbound.security = p.cipher || 'zero';
                outbound.packet_encoding = "";
                outbound.domain_strategy = "prefer_ipv4";
            } else if (p.type === 'vless') {
                outbound.uuid = p.uuid;
                outbound.flow = "";
                outbound.packet_encoding = "xudp";
                outbound.domain_strategy = "ipv4_only";
            } else if (p.type === 'trojan') {
                outbound.password = p.password;
                outbound.domain_strategy = "ipv4_only";
            } else if (p.type === 'ss') {
                 outbound.method = p.cipher || 'none';
                 outbound.password = p.password;
                 if(p.network === 'ws') {
                    outbound.plugin = "v2ray-plugin";
                    outbound.plugin_opts = `mux=0;path=${p.wsPath};host=${p.wsHost || p.server};tls=${p.tls ? '1' : '0'}`;
                 }
            }
            
            if (p.tls) {
                outbound.tls = {
                    enabled: true,
                    insecure: false,
                    server_name: p.sni || p.server,
                    utls: { enabled: true, fingerprint: "randomized" }
                };
            }

            if (p.network === 'ws') {
                outbound.transport = {
                    type: "ws",
                    path: p.wsPath,
                    headers: { Host: p.wsHost || p.server },
                };
            }
            
            outbounds.push(outbound);
        });

        outbounds.push({ tag: "direct", type: "direct" });
        outbounds.push({ tag: "bypass", type: "direct" });
        outbounds.push({ tag: "block", type: "block" });
        outbounds.push({ tag: "dns-out", type: "dns" });

        const config = {
            "dns": {
                "final": "dns-final",
                "independent_cache": true,
                "rules": [{ "disable_cache": false, "domain": ["family.cloudflare-dns.com"], "server": "direct-dns" }],
                "servers": [
                    { "address": "https://family.cloudflare-dns.com/dns-query", "address_resolver": "direct-dns", "strategy": "ipv4_only", "tag": "remote-dns" },
                    { "address": "local", "strategy": "ipv4_only", "tag": "direct-dns" },
                    { "address": "local", "address_resolver": "dns-local", "strategy": "ipv4_only", "tag": "dns-final" },
                    { "address": "local", "tag": "dns-local" },
                    { "address": "rcode://success", "tag": "dns-block" }
                ]
            },
            "experimental": {
                "cache_file": { "enabled": true, "path": "../cache/clash.db", "store_fakeip": true },
                "clash_api": { "external_controller": "127.0.0.1:9090", "external_ui": "../files/yacd" }
            },
            "inbounds": [
                { "listen": "0.0.0.0", "listen_port": 6450, "override_address": "8.8.8.8", "override_port": 53, "tag": "dns-in", "type": "direct" },
                { "domain_strategy": "", "endpoint_independent_nat": true, "inet4_address": ["172.19.0.1/28"], "mtu": 9000, "sniff": true, "sniff_override_destination": true, "stack": "system", "tag": "tun-in", "type": "tun" },
                { "domain_strategy": "", "listen": "0.0.0.0", "listen_port": 2080, "sniff": true, "sniff_override_destination": true, "tag": "mixed-in", "type": "mixed" }
            ],
            "log": { "level": "info" },
            "outbounds": outbounds,
            "route": {
                "auto_detect_interface": true,
                "rules": [
                    { "outbound": "dns-out", "port": [53] },
                    { "inbound": ["dns-in"], "outbound": "dns-out" },
                    { "network": ["udp"], "outbound": "block", "port": [443] },
                    { "ip_cidr": ["224.0.0.0/3", "ff00::/8"], "outbound": "block", "source_ip_cidr": ["224.0.0.0/3", "ff00::/8"] }
                ]
            }
        };

        return `##GEO-PROJECT##\n${JSON.stringify(config, null, 2)}`;
    }


    // Initialize UI
    toggleClashOptions();
    updateSaveButtons();
});
</script>
</body>
</html>
